<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>OceanZ - Admin Dashboard</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="OceanZ Gaming Cafe Admin Dashboard - Terminal status, bookings, and analytics"/>
  <meta name="theme-color" content="#ff0044"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="OceanZ Admin"/>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" type="image/svg+xml" href="../assets/icons/admin-icon.svg"/>
  <link rel="apple-touch-icon" href="../assets/icons/admin-icon.svg"/>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/common.css">
  <link rel="stylesheet" href="../assets/css/admin.css">
  <style>
    /* Page-specific styles - most styles are in common.css and admin.css */

    /* Sidebar */
    .sidebar {
      background: var(--card-bg);
      border-right: 1px solid var(--card-border);
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease;
    }

    /* Mobile Sidebar */
    @media (max-width: 767px) {
      .sidebar {
        transform: translateX(-100%);
        display: flex !important;
      }
      .sidebar.open {
        transform: translateX(0);
      }
    }

    /* Sidebar Backdrop */
    .sidebar-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 35;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .sidebar-backdrop.show {
      opacity: 1;
      visibility: visible;
    }

    /* Mobile Header & Hamburger - Moved to admin.css */

    /* Close button for sidebar */
    .sidebar-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 32px;
      height: 32px;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(255, 0, 68, 0.1);
      border: 1px solid rgba(255, 0, 68, 0.3);
      border-radius: 8px;
      color: var(--neon-red);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .sidebar-close:hover {
      background: rgba(255, 0, 68, 0.2);
    }

    @media (max-width: 767px) {
      .sidebar-close {
        display: flex;
      }
    }

    .nav-item {
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: rgba(255, 0, 68, 0.1);
      border-color: rgba(255, 0, 68, 0.3);
    }

    .nav-item.active {
      background: rgba(255, 0, 68, 0.15);
      border-color: var(--neon-red);
      box-shadow: 0 0 15px rgba(255, 0, 68, 0.3);
    }

    .nav-item.active span {
      color: var(--neon-red);
      text-shadow: 0 0 10px var(--neon-red);
    }

    /* Neon Card */
    .neon-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      box-shadow: 0 0 30px rgba(255, 0, 68, 0.05);
      backdrop-filter: blur(10px);
    }

    .neon-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--neon-red), transparent);
      opacity: 0.5;
    }

    /* Glow Effects */
    .glow-red { text-shadow: 0 0 10px var(--neon-red), 0 0 20px var(--neon-red); }
    .glow-cyan { text-shadow: 0 0 10px var(--neon-cyan), 0 0 20px var(--neon-cyan); }
    .glow-green { text-shadow: 0 0 10px var(--neon-green), 0 0 20px var(--neon-green); }
    .glow-purple { text-shadow: 0 0 10px var(--neon-purple), 0 0 20px var(--neon-purple); }
    .glow-yellow { text-shadow: 0 0 10px var(--neon-yellow), 0 0 20px var(--neon-yellow); }

    /* Neon Button */
    .neon-btn {
      background: linear-gradient(135deg, rgba(255, 0, 68, 0.2), rgba(184, 41, 255, 0.2));
      border: 1px solid var(--neon-red);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .neon-btn:hover {
      background: linear-gradient(135deg, var(--neon-red), var(--neon-purple));
      box-shadow: 0 0 20px rgba(255, 0, 68, 0.5);
      transform: translateY(-2px);
    }

    .neon-btn-green {
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 200, 100, 0.2));
      border-color: var(--neon-green);
    }

    .neon-btn-green:hover {
      background: linear-gradient(135deg, var(--neon-green), #00cc66);
      box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
    }

    .neon-btn-cyan {
      background: linear-gradient(135deg, rgba(0, 240, 255, 0.2), rgba(0, 200, 255, 0.2));
      border-color: var(--neon-cyan);
    }

    .neon-btn-cyan:hover {
      background: linear-gradient(135deg, var(--neon-cyan), #00aaff);
      box-shadow: 0 0 20px rgba(0, 240, 255, 0.5);
    }

    .neon-btn-purple {
      background: linear-gradient(135deg, rgba(184, 41, 255, 0.2), rgba(150, 30, 200, 0.2));
      border-color: var(--neon-purple);
    }

    .neon-btn-purple:hover {
      background: linear-gradient(135deg, var(--neon-purple), #9920cc);
      box-shadow: 0 0 20px rgba(184, 41, 255, 0.5);
    }

    /* Input Styles */
    .neon-input {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 0, 68, 0.3);
      transition: all 0.3s ease;
    }

    .neon-input:focus {
      border-color: var(--neon-red);
      box-shadow: 0 0 15px rgba(255, 0, 68, 0.3);
      outline: none;
    }

    .neon-select {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 0, 68, 0.3);
    }

    .neon-select:focus {
      border-color: var(--neon-red);
      box-shadow: 0 0 15px rgba(255, 0, 68, 0.3);
      outline: none;
    }

    /* Terminal Card */
    .terminal-card {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 0, 68, 0.2);
      transition: all 0.3s ease;
    }

    .terminal-card:hover {
      border-color: var(--neon-red);
      transform: translateY(-2px);
    }

    .terminal-card.occupied {
      border-color: var(--neon-red);
      box-shadow: 0 0 15px rgba(255, 0, 68, 0.3);
    }

    .terminal-card.available {
      border-color: var(--neon-green);
      box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
    }

    /* Member Card */
    .member-card {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(0, 240, 255, 0.2);
      transition: all 0.3s ease;
    }

    .member-card:hover {
      border-color: var(--neon-cyan);
      background: rgba(0, 240, 255, 0.05);
    }

    /* Booking Card */
    .booking-card {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 0, 68, 0.2);
      transition: all 0.3s ease;
    }

    .booking-card:hover {
      border-color: var(--neon-red);
      transform: translateY(-2px);
    }

    /* Status Badges */
    .status-approved { 
      background: rgba(0, 255, 136, 0.2); 
      border: 1px solid var(--neon-green);
      color: var(--neon-green);
    }
    .status-pending { 
      background: rgba(255, 255, 0, 0.2); 
      border: 1px solid var(--neon-yellow);
      color: var(--neon-yellow);
    }
    .status-declined { 
      background: rgba(255, 0, 100, 0.2); 
      border: 1px solid #ff0064;
      color: #ff0064;
    }

    /* Stat Card */
    .stat-card {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 0, 68, 0.2);
      position: relative;
      overflow: hidden;
    }

    .stat-card::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--neon-red), var(--neon-purple));
    }

    /* Recharge Table */
    #rechargeList tr {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    #rechargeList tr:last-child {
      border-bottom: none;
    }

    /* Payment Badges */
    .payment-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      font-size: 0.7rem;
      font-weight: 600;
      font-family: 'Orbitron', sans-serif;
      white-space: nowrap;
    }

    .payment-badge.cash {
      background: rgba(0, 240, 255, 0.15);
      color: #00f0ff;
      border: 1px solid rgba(0, 240, 255, 0.3);
    }

    .payment-badge.upi {
      background: rgba(184, 41, 255, 0.15);
      color: #b829ff;
      border: 1px solid rgba(184, 41, 255, 0.3);
    }

    .payment-badge.credit-pending {
      background: rgba(255, 107, 0, 0.15);
      color: #ff6b00;
      border: 1px solid rgba(255, 107, 0, 0.3);
    }

    .payment-badge.credit-paid {
      background: rgba(0, 255, 136, 0.15);
      color: #00ff88;
      border: 1px solid rgba(0, 255, 136, 0.3);
    }

    .payment-badge.free {
      background: rgba(255, 255, 0, 0.15);
      color: #ffff00;
      border: 1px solid rgba(255, 255, 0, 0.3);
    }

    /* Table Scrollbar */
    .overflow-x-auto::-webkit-scrollbar {
      height: 6px;
    }

    .overflow-x-auto::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }

    .overflow-x-auto::-webkit-scrollbar-thumb {
      background: var(--neon-red);
      border-radius: 3px;
    }

    /* Audit Filter Buttons */
    .audit-filter {
      background: rgba(100, 100, 100, 0.2);
      color: #888;
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }

    .audit-filter:hover {
      background: rgba(184, 41, 255, 0.1);
      color: #b829ff;
    }

    .audit-filter.active {
      background: rgba(184, 41, 255, 0.2);
      color: #b829ff;
      border-color: rgba(184, 41, 255, 0.5);
    }

    /* Audit Entry */
    .audit-entry {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 12px;
      transition: all 0.2s ease;
    }

    .audit-entry:hover {
      background: rgba(0, 0, 0, 0.5);
    }

    .audit-entry.action-ADD { border-left: 3px solid #00ff88; }
    .audit-entry.action-EDIT { border-left: 3px solid #00f0ff; }
    .audit-entry.action-DELETE { border-left: 3px solid #ff0044; }
    .audit-entry.action-CREDIT_PAID { border-left: 3px solid #00ff88; }

    /* Credit Item */
    .credit-item {
      background: rgba(255, 107, 0, 0.1);
      border: 1px solid rgba(255, 107, 0, 0.3);
      border-radius: 8px;
      padding: 12px;
      transition: all 0.2s ease;
    }

    .credit-item:hover {
      border-color: rgba(255, 107, 0, 0.5);
    }

    .credit-item.paid {
      background: rgba(0, 255, 136, 0.05);
      border-color: rgba(0, 255, 136, 0.3);
      opacity: 0.7;
    }

    .mark-paid-btn {
      background: linear-gradient(135deg, rgba(0,255,136,0.2), rgba(0,200,100,0.2));
      border: 1px solid rgba(0,255,136,0.5);
      color: #00ff88;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .mark-paid-btn:hover {
      background: linear-gradient(135deg, #00ff88, #00cc66);
      color: #000;
    }

    /* Timetable */
    .timetable-row {
      background: rgba(0, 0, 0, 0.3);
    }

    .timetable-block {
      transition: all 0.3s ease;
    }

    .timetable-block:hover {
      transform: scaleY(1.1);
    }

    /* Audit Log */
    .audit-item {
      background: rgba(0, 0, 0, 0.3);
      border-left: 2px solid var(--neon-purple);
    }

    /* Logout Button */
    .logout-btn {
      background: rgba(255, 0, 68, 0.1);
      border: 1px solid rgba(255, 0, 68, 0.5);
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: rgba(255, 0, 68, 0.3);
      box-shadow: 0 0 15px rgba(255, 0, 68, 0.4);
    }

    /* Cyber Lines */
    .cyber-line {
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--neon-red), transparent);
    }

    /* Loading Screen */
    .loading-spinner {
      border: 3px solid transparent;
      border-top-color: var(--neon-red);
      border-right-color: var(--neon-purple);
    }

    /* Chart container */
    .chart-container {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 0, 68, 0.1);
      border-radius: 12px;
      padding: 1rem;
    }

    /* Alert pulse */
    .alert-pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 10px rgba(255, 0, 68, 0.4); }
      50% { box-shadow: 0 0 25px rgba(255, 0, 68, 0.8); }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
    ::-webkit-scrollbar-thumb { background: var(--neon-red); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--neon-purple); }
    
    /* Thin scrollbar for sidebar */
    .scrollbar-thin::-webkit-scrollbar { width: 4px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

    /* Chevron rotation for collapsible sections */
    .rotate-180 { transform: rotate(180deg); }

    /* ==================== MOBILE UI ENHANCEMENTS ==================== */
    
    /* Mobile Typography */
    @media (max-width: 767px) {
      html { font-size: 14px; }
      
      .font-orbitron { letter-spacing: 0.5px; }
      
      h1, .text-3xl { font-size: 1.5rem !important; }
      h2, .text-2xl { font-size: 1.25rem !important; }
      h3, .text-xl { font-size: 1.1rem !important; }
      
      /* Better touch targets - minimum 44x44px */
      .neon-btn, button, .nav-item {
        min-height: 44px;
      }
      
      /* Mobile main content padding */
      .main-content {
        padding: 1rem !important;
        padding-top: 80px !important;
      }
      
      /* Mobile sidebar improvements */
      .sidebar {
        width: 85vw !important;
        max-width: 320px;
        padding-top: 1rem;
      }
      
      .sidebar .nav-item {
        padding: 14px 16px !important;
        font-size: 0.95rem;
      }
      
      /* Mobile header sticky */
      .mobile-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 64px;
        padding: 0 16px;
        z-index: 50;
      }
      
      /* Stat cards - 2 column grid on mobile */
      .grid-cols-2.md\\:grid-cols-4,
      .grid-cols-2.md\\:grid-cols-5 {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 10px !important;
      }
      
      .stat-card {
        padding: 12px !important;
      }
      
      .stat-card .text-2xl {
        font-size: 1.1rem !important;
      }
      
      .stat-card .text-xs {
        font-size: 0.65rem !important;
      }
      
      /* Terminal grid - 2 columns on mobile */
      .grid-cols-2.sm\\:grid-cols-3.md\\:grid-cols-4.lg\\:grid-cols-5 {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
      }
      
      .terminal-card {
        padding: 10px !important;
      }
      
      .terminal-card .text-xl {
        font-size: 1rem !important;
      }
      
      /* Neon cards */
      .neon-card {
        border-radius: 12px !important;
      }
      
      /* Table mobile styles */
      .overflow-x-auto {
        margin: 0 -1rem;
        padding: 0 1rem;
        -webkit-overflow-scrolling: touch;
      }
      
      table {
        min-width: 600px;
      }
      
      table th, table td {
        padding: 10px 8px !important;
        font-size: 0.75rem !important;
      }
      
      /* Mobile table - card style alternative */
      .mobile-card-view {
        display: block !important;
      }
      
      .mobile-card-view thead {
        display: none;
      }
      
      .mobile-card-view tbody {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .mobile-card-view tr {
        display: flex;
        flex-direction: column;
        background: rgba(0,0,0,0.3);
        border-radius: 10px;
        padding: 12px;
        border: 1px solid rgba(255,255,255,0.05);
      }
      
      .mobile-card-view td {
        display: flex;
        justify-content: space-between;
        padding: 6px 0 !important;
        border-bottom: 1px solid rgba(255,255,255,0.05);
      }
      
      .mobile-card-view td:last-child {
        border-bottom: none;
      }
      
      .mobile-card-view td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #888;
        font-size: 0.7rem;
        text-transform: uppercase;
      }
      
      /* Payment badges mobile */
      .payment-badge {
        padding: 3px 6px !important;
        font-size: 0.6rem !important;
      }
      
      /* Credit items mobile */
      .credit-item {
        flex-direction: column !important;
        gap: 12px !important;
      }
      
      .credit-item > div:last-child {
        width: 100%;
        justify-content: flex-end;
      }
      
      /* Buttons mobile */
      .neon-btn {
        padding: 12px 16px !important;
        font-size: 0.85rem !important;
      }
      
      /* Input fields mobile */
      .neon-input, .neon-select {
        padding: 12px !important;
        font-size: 16px !important; /* Prevents zoom on iOS */
      }
      
      /* Modal mobile */
      .fixed.inset-0.z-50 > div {
        margin: 1rem !important;
        max-height: calc(100vh - 2rem);
        overflow-y: auto;
      }
      
      /* Add recharge modal mobile */
      #addRechargeModal > div,
      #collectCreditModal > div {
        padding: 1rem !important;
        border-radius: 16px !important;
      }
      
      #addRechargeModal .grid-cols-2,
      #addRechargeModal .grid-cols-3 {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
      }
      
      /* Split payment section mobile */
      #addRechargeModal .grid-cols-3.gap-3 {
        grid-template-columns: repeat(3, 1fr) !important;
      }
      
      /* Bookings section mobile */
      .booking-card {
        padding: 12px !important;
      }
      
      .booking-card .flex.gap-4 {
        flex-direction: column;
        gap: 8px !important;
      }
      
      /* Timetable mobile */
      .timetable-container {
        margin: 0 -1rem;
      }
      
      /* Audit log mobile */
      .audit-entry {
        padding: 10px !important;
      }
      
      .audit-entry .flex.items-start {
        flex-direction: column;
        gap: 8px;
      }
      
      .audit-entry .text-right {
        text-align: left !important;
        display: flex;
        gap: 8px;
      }
      
      /* Section headers mobile */
      .flex.flex-wrap.justify-between {
        flex-direction: column;
        gap: 12px !important;
      }
      
      /* Date picker and action buttons mobile */
      .flex.gap-2 {
        flex-wrap: wrap;
      }
      
      /* Outstanding credits mobile */
      /* Removed - handled by admin.css */
      
      /* Search inputs mobile - ensure text doesn't overlap icon */
      #rechargeSearch {
        width: 100% !important;
        padding-left: 40px !important;
        text-indent: 0 !important;
      }
      
      #bookingSearch {
        padding-left: 32px !important;
        text-indent: 0 !important;
      }
      
      /* Table header with search mobile */
      .p-4.border-b.flex.flex-wrap {
        flex-direction: column;
        gap: 12px !important;
      }
      
      /* Analytics charts mobile */
      .chart-container {
        padding: 0.75rem !important;
      }
      
      .chart-container canvas {
        max-height: 200px !important;
      }
      
      /* Staff cards mobile */
      .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3 {
        gap: 12px !important;
      }
      
      /* Logout modal mobile */
      #logoutModal > div {
        margin: 1rem;
      }
      
      /* PWA Install banner mobile */
      #pwaInstallBanner {
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        border-radius: 16px 16px 0 0 !important;
        padding: 16px !important;
      }
      
      /* Floating action button style for Add Recharge */
      .mobile-fab {
        position: fixed;
        bottom: 80px;
        right: 16px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 20px rgba(0, 255, 136, 0.4);
        z-index: 20;
      }
    }
    
    /* Small mobile screens (< 375px) */
    @media (max-width: 374px) {
      html { font-size: 13px; }
      
      .stat-card .text-2xl {
        font-size: 1rem !important;
      }
      
      .grid-cols-2.md\\:grid-cols-4,
      .grid-cols-2.md\\:grid-cols-5 {
        gap: 8px !important;
      }
      
      .terminal-card {
        padding: 8px !important;
      }
      
      #addRechargeModal .grid-cols-3.gap-3 {
        grid-template-columns: 1fr 1fr 1fr !important;
      }
    }
    
    /* Safe area insets for notched devices */
    @supports (padding: env(safe-area-inset-bottom)) {
      @media (max-width: 767px) {
        .main-content {
          padding-bottom: calc(1rem + env(safe-area-inset-bottom)) !important;
        }
        
        #pwaInstallBanner {
          padding-bottom: calc(16px + env(safe-area-inset-bottom)) !important;
        }
        
        .mobile-fab {
          bottom: calc(80px + env(safe-area-inset-bottom));
        }
      }
    }
    
    /* Smooth animations */
    @media (prefers-reduced-motion: no-preference) {
      .sidebar {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .sidebar-backdrop {
        transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .neon-card, .stat-card, .terminal-card {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }
    }
    
    /* Dark mode optimizations */
    @media (prefers-color-scheme: dark) {
      input, select, textarea {
        color-scheme: dark;
      }
    }
    
    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {
      .neon-btn:hover,
      .nav-item:hover,
      .terminal-card:hover,
      .member-card:hover,
      .booking-card:hover {
        transform: none;
      }
      
      .neon-btn:active,
      .nav-item:active {
        transform: scale(0.98);
      }
    }
  </style>
</head>
<body class="admin-page text-white min-h-screen relative">

  <!-- Loading Screen -->
  <div id="loading-screen" class="min-h-screen flex items-center justify-center relative z-10">
    <div class="text-center">
      <div class="w-16 h-16 mx-auto mb-4 relative">
        <div class="absolute inset-0 loading-spinner rounded-full animate-spin"></div>
        <div class="absolute inset-2 loading-spinner rounded-full animate-spin" style="animation-direction: reverse; animation-duration: 0.8s;"></div>
      </div>
      <p class="text-gray-400 font-orbitron text-sm tracking-wider">INITIALIZING DASHBOARD...</p>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" class="hidden flex min-h-screen relative z-10">
    <!-- Mobile Header -->
    <header class="mobile-header">
      <button id="hamburger-btn" class="hamburger-btn" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="mobile-header-brand">
        <svg viewBox="0 0 100 100" class="w-7 h-7">
          <polygon points="50,5 95,25 95,60 50,95 5,60 5,25" 
            fill="none" stroke="url(#mobileGradient)" stroke-width="3"/>
          <defs>
            <linearGradient id="mobileGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#ff0044"/>
              <stop offset="100%" style="stop-color:#b829ff"/>
            </linearGradient>
          </defs>
        </svg>
        <div class="mobile-header-text">
          <span class="mobile-header-title">OCEANZ</span>
          <span class="mobile-header-subtitle">ADMIN</span>
        </div>
      </div>
      <div id="mobile-header-user" class="mobile-header-user">
        <span class="mobile-user-initial">A</span>
      </div>
    </header>

    <!-- Sidebar Backdrop -->
    <div id="sidebar-backdrop" class="sidebar-backdrop"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar w-64 fixed inset-y-0 left-0 z-40 hidden md:flex flex-col p-4">
      <!-- Header with Close button (mobile only) -->
      <div class="flex items-center justify-between mb-4 md:mb-0">
        <span class="md:hidden text-xs text-gray-600 font-orbitron">MENU</span>
        <button id="sidebar-close" class="sidebar-close md:hidden w-8 h-8 flex items-center justify-center rounded-lg" 
          style="background: rgba(255,0,68,0.1); border: 1px solid rgba(255,0,68,0.3);" aria-label="Close menu">
          <i data-lucide="x" class="w-4 h-4" style="color: var(--neon-red);"></i>
        </button>
      </div>
      
      <!-- Logo + User Info (Horizontal) -->
      <div class="mb-4 p-3 rounded-xl flex items-center gap-3" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05);">
        <!-- Logo -->
        <div class="w-10 h-10 shrink-0">
          <svg viewBox="0 0 100 100" class="w-full h-full">
            <polygon points="50,5 95,25 95,60 50,95 5,60 5,25" 
              fill="none" stroke="url(#sidebarGradient)" stroke-width="2"/>
            <defs>
              <linearGradient id="sidebarGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#ff0044"/>
                <stop offset="100%" style="stop-color:#b829ff"/>
              </linearGradient>
            </defs>
          </svg>
        </div>
        <!-- Branding + User -->
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-1">
            <span class="font-orbitron text-sm font-bold" style="color: var(--neon-red);">OCEANZ</span>
            <span class="text-xs text-gray-600">ADMIN</span>
          </div>
          <div id="currentUserName" class="font-orbitron text-xs truncate mt-0.5" style="color: var(--neon-cyan);">-</div>
          <div id="currentUserRole" class="inline-block mt-1 text-[10px] px-1.5 py-0.5 rounded font-orbitron">-</div>
        </div>
      </div>

      <!-- Nav Items (dynamically filtered by permissions) -->
      <nav id="mainNav" class="flex-1 space-y-2 overflow-y-auto scrollbar-thin">
        <a id="nav-recharges" href="#" data-permission="recharges" class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg">
          <i data-lucide="wallet" class="w-5 h-5"></i>
          <span class="font-medium">Recharges</span>
        </a>
        <a id="nav-dashboard" href="#" data-permission="dashboard" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
          <span class="font-medium">Dashboard</span>
        </a>
        <a id="nav-bookings" href="#" data-permission="bookings" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400">
          <i data-lucide="calendar-clock" class="w-5 h-5"></i>
          <span class="font-medium">Bookings</span>
        </a>
        <a id="nav-members" href="#" data-permission="members" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400">
          <i data-lucide="users" class="w-5 h-5"></i>
          <span class="font-medium">Members</span>
        </a>
        <a id="nav-analytics" href="#" data-permission="analytics" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400">
          <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
          <span class="font-medium">Analytics</span>
        </a>
        <a id="nav-cash" href="#" data-permission="cash_register" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400">
          <i data-lucide="banknote" class="w-5 h-5"></i>
          <span class="font-medium">Cash Register</span>
        </a>
        <a id="nav-leaderboard" href="#" data-permission="leaderboard" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400">
          <i data-lucide="trophy" class="w-5 h-5"></i>
          <span class="font-medium">Leaderboards</span>
        </a>
        <a id="nav-staff" href="#" data-permission="staff" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400">
          <i data-lucide="shield-check" class="w-5 h-5"></i>
          <span class="font-medium">Staff</span>
        </a>
      </nav>

      <!-- Footer -->
      <div class="pt-4 border-t border-gray-800 space-y-2">
        <!-- Sync Button -->
        <button id="syncBtn" onclick="openSyncPanel()" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:text-green-400" style="border: 1px solid transparent;">
          <i data-lucide="refresh-cw" class="w-5 h-5"></i>
          <span class="font-medium">Sync Database</span>
          <span id="syncStatusDot" class="ml-auto w-2 h-2 rounded-full bg-gray-600"></span>
        </button>
        <a href="../member/login.html" target="_blank" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-500 hover:text-cyan-400">
          <i data-lucide="external-link" class="w-5 h-5"></i>
          <span class="font-medium">Member Portal</span>
        </a>
        <button id="logout-btn" class="logout-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg" style="color: var(--neon-red);">
          <i data-lucide="log-out" class="w-5 h-5"></i>
          <span class="font-medium">Logout</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content flex-1 p-6 ml-0 md:ml-64">
      <div class="max-w-7xl mx-auto space-y-8">

        <!-- Dashboard Section -->
        <div id="dashboard-section">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h1 class="font-orbitron text-3xl font-bold glow-red" style="color: var(--neon-red);">TERMINAL STATUS</h1>
              <p id="timestamp" class="text-sm text-gray-500 mt-1"></p>
            </div>
          </div>
          <div id="group-container" class="space-y-8"></div>
        </div>

        <!-- Members Section -->
        <div id="members-section" class="hidden">
          <h2 class="font-orbitron text-2xl font-bold mb-6 glow-cyan flex items-center gap-3" style="color: var(--neon-cyan);">
            <i data-lucide="users" class="w-7 h-7"></i> MEMBERS DATABASE
          </h2>
          <div id="membersList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <!-- Bookings Section -->
        <div id="bookings-section" class="hidden">
          <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
            <h2 class="font-orbitron text-xl font-bold glow-purple flex items-center gap-3" style="color: var(--neon-purple);">
              <i data-lucide="calendar-clock" class="w-6 h-6"></i> BOOKINGS
            </h2>
            <div class="flex gap-2 flex-wrap items-center">
              <div class="relative booking-search-wrapper">
                <input type="text" id="bookingSearch" placeholder="" 
                  class="neon-input pl-8 pr-8 py-2 rounded-lg text-xs w-28 sm:w-40"
                  oninput="filterBookings(this.value)" />
                <i data-lucide="search" class="w-3.5 h-3.5 absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-500"></i>
                <button type="button" id="bookingSearchClear" 
                  class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-white hidden"
                  onclick="document.getElementById('bookingSearch').value=''; filterBookings(''); this.classList.add('hidden');">
                  <i data-lucide="x" class="w-3.5 h-3.5"></i>
                </button>
              </div>
              <button onclick="downloadPDF()" class="neon-btn-green neon-btn px-3 py-2 rounded-lg flex items-center gap-1 text-xs">
                <i data-lucide="file-text" class="w-3.5 h-3.5"></i> PDF
              </button>
            </div>
          </div>

          <!-- Collapsible Timetable -->
          <div class="neon-card rounded-2xl mb-6 relative overflow-hidden">
            <button id="timetableToggle" class="w-full p-4 flex items-center justify-between text-left hover:bg-gray-800/30 transition-colors">
              <div class="flex items-center gap-3">
                <span style="color: var(--neon-cyan);">üïí</span>
                <h3 class="font-orbitron text-sm font-bold" style="color: var(--neon-cyan);">BOOKING TIMETABLE</h3>
                <span id="timetableDateBadge" class="text-xs px-2 py-0.5 rounded-full" style="background: rgba(0,240,255,0.2); color: var(--neon-cyan);"></span>
              </div>
              <i data-lucide="chevron-down" id="timetableChevron" class="w-5 h-5 transition-transform" style="color: var(--neon-cyan);"></i>
            </button>
            <div id="timetableContainer" class="border-t border-gray-800">
              <!-- Legend -->
              <div class="timetable-legend mx-4 mt-4">
                <div class="legend-item">
                  <div class="legend-dot legend-dot-running"></div>
                  <span>üéÆ Running</span>
                  <span id="legendRunning" class="legend-count" style="color: #00ff88;">0</span>
                </div>
                <div class="legend-item">
                  <div class="legend-dot legend-dot-soon"></div>
                  <span>‚è∞ Starting Soon</span>
                  <span id="legendSoon" class="legend-count" style="color: #ff6b00;">0</span>
                </div>
                <div class="legend-item">
                  <div class="legend-dot legend-dot-approved"></div>
                  <span>‚úì Approved</span>
                  <span id="legendApproved" class="legend-count" style="color: #00f0ff;">0</span>
                </div>
                <div class="legend-item">
                  <div class="legend-dot legend-dot-pending"></div>
                  <span>‚è≥ Pending</span>
                  <span id="legendPending" class="legend-count" style="color: #ffff00;">0</span>
                </div>
              </div>
              <div id="timetableWrapper" class="overflow-x-auto p-4 pt-2">
                <div id="timetableInner" class="relative">
                  <div id="timeHeader" class="grid grid-cols-[140px_repeat(12,_1fr)] text-xs text-gray-500 mb-2"></div>
                  <div id="timetableBody" class="space-y-2"></div>
                </div>
              </div>
            </div>
          </div>
          <div id="bookingCards" class="flex flex-col gap-6"></div>
        </div>

        <!-- Recharges Section -->
        <div id="recharges-section" class="hidden">
          <div class="space-y-6">
            <div class="flex flex-wrap justify-between gap-4 items-center">
              <h2 class="font-orbitron text-2xl font-bold glow-green flex items-center gap-3" style="color: var(--neon-green);">
                üí≥ DAILY RECHARGES
              </h2>
              <div class="flex gap-2">
                <input type="date" id="datePicker" class="neon-input px-3 py-2 rounded-lg text-white"/>
                <button onclick="exportMonthPDF()" class="neon-btn-cyan neon-btn px-4 py-2 rounded-lg text-sm">üìÑ Export PDF</button>
                <button onclick="printSheet()" class="neon-btn-purple neon-btn px-4 py-2 rounded-lg text-sm">üñ® Print</button>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <button onclick="openAddRechargeModal()" class="neon-btn neon-btn-green w-full rounded-xl px-6 py-4 font-orbitron text-lg flex items-center justify-center gap-3">
                <span class="text-2xl">‚ûï</span> ADD RECHARGE
              </button>
              <button onclick="openSyncModal()" class="neon-btn neon-btn-cyan w-full rounded-xl px-6 py-4 font-orbitron text-lg flex items-center justify-center gap-3">
                <span class="text-2xl">üîÑ</span> SYNC WITH PANCAFE
              </button>
            </div>

            <!-- Summary -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
              <div class="stat-card p-4 rounded-xl text-center">
                <div class="text-gray-500 text-xs uppercase tracking-wider">Total Collected</div>
                <div id="totalAmount" class="text-2xl font-bold font-orbitron mt-1" style="color: var(--neon-green);">‚Çπ0</div>
              </div>
              <div class="stat-card p-4 rounded-xl text-center">
                <div class="text-gray-500 text-xs uppercase tracking-wider">Cash</div>
                <div id="cashTotal" class="text-2xl font-bold font-orbitron mt-1" style="color: var(--neon-cyan);">‚Çπ0</div>
              </div>
              <div class="stat-card p-4 rounded-xl text-center">
                <div class="text-gray-500 text-xs uppercase tracking-wider">UPI</div>
                <div id="upiTotal" class="text-2xl font-bold font-orbitron mt-1" style="color: var(--neon-purple);">‚Çπ0</div>
              </div>
              <div class="stat-card p-4 rounded-xl text-center" style="border-color: rgba(255,107,0,0.3);">
                <div class="text-gray-500 text-xs uppercase tracking-wider">Credit (Pending)</div>
                <div id="creditTotal" class="text-2xl font-bold font-orbitron mt-1" style="color: var(--neon-orange);">‚Çπ0</div>
              </div>
              <div class="stat-card p-4 rounded-xl text-center" style="border-color: rgba(255,255,0,0.3);">
                <div class="text-gray-500 text-xs uppercase tracking-wider">üéÅ Free Given</div>
                <div id="freeTotal" class="text-2xl font-bold font-orbitron mt-1" style="color: var(--neon-yellow);">‚Çπ0</div>
              </div>
            </div>

            <!-- Credits Row - Outstanding & Collected Side by Side on Desktop -->
            <div id="creditsRowContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <!-- Outstanding Credits Section -->
              <div id="outstandingCreditsSection" class="hidden">
                <div class="neon-card rounded-xl p-4 relative h-full" style="border-color: rgba(255,107,0,0.3);">
                  <div class="flex items-center justify-between mb-3">
                    <h3 class="font-orbitron text-xs font-bold flex items-center gap-2" style="color: var(--neon-orange);">
                      üîñ OUTSTANDING CREDITS
                      <span id="outstandingCount" class="text-xs px-2 py-0.5 rounded-full" style="background: rgba(255,107,0,0.2);">0</span>
                    </h3>
                    <span id="outstandingTotal" class="font-orbitron text-sm font-bold" style="color: var(--neon-orange);">‚Çπ0</span>
                  </div>
                  <div id="outstandingCreditsList" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>
              </div>

              <!-- Credit Collections from Other Dates (collected today) -->
              <div id="otherDayCollectionsSection" class="hidden">
                <div class="neon-card rounded-xl p-4 relative h-full" style="border-color: rgba(0,255,136,0.3);">
                  <div class="flex items-center justify-between mb-3">
                    <h3 class="font-orbitron text-xs font-bold flex items-center gap-2" style="color: var(--neon-green);">
                      üí∞ COLLECTED TODAY
                      <span id="otherDayCollectionCount" class="text-xs px-2 py-0.5 rounded-full" style="background: rgba(0,255,136,0.2);">0</span>
                    </h3>
                    <span id="otherDayCollectionTotal" class="font-orbitron text-sm font-bold" style="color: var(--neon-green);">‚Çπ0</span>
                  </div>
                  <div id="otherDayCollectionsList" class="space-y-1 max-h-48 overflow-y-auto"></div>
                </div>
              </div>
            </div>

            <!-- Recharge List - Table Style -->
            <div class="neon-card rounded-xl overflow-hidden w-full">
              <!-- Table Header with Search -->
              <div class="p-4 border-b border-gray-800 flex flex-wrap items-center justify-between gap-3 w-full">
                <h3 class="font-orbitron text-sm font-bold flex items-center gap-2" style="color: var(--neon-cyan);">
                  üìã TODAY'S TRANSACTIONS
                  <span id="rechargeCount" class="text-xs px-2 py-0.5 rounded-full" style="background: rgba(0,240,255,0.2);">0</span>
                </h3>
                <div class="relative">
                  <input type="text" id="rechargeSearch" placeholder="" 
                    class="neon-input px-4 py-2 pl-10 rounded-lg text-sm w-full sm:w-64"
                    oninput="filterRechargeList()"/>
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">üîç</span>
                </div>
              </div>
              
              <!-- Table -->
              <div class="recharge-table-wrapper w-full">
                <table class="w-full text-sm recharge-table" style="width: 100% !important;">
                  <thead class="bg-gray-900/50">
                    <tr class="text-left">
                      <th class="px-4 py-3 font-orbitron text-xs uppercase tracking-wider" style="color: var(--neon-purple);">Time</th>
                      <th class="px-4 py-3 font-orbitron text-xs uppercase tracking-wider" style="color: var(--neon-cyan);">Member</th>
                      <th class="px-4 py-3 font-orbitron text-xs uppercase tracking-wider text-right" style="color: var(--neon-green);">Amt</th>
                      <th class="px-4 py-3 font-orbitron text-xs uppercase tracking-wider recharge-col-payment" style="color: var(--neon-yellow);">Pay</th>
                      <th class="px-4 py-3 font-orbitron text-xs uppercase tracking-wider text-gray-500 recharge-col-note">Note</th>
                      <th class="px-4 py-3 font-orbitron text-xs uppercase tracking-wider text-gray-500 recharge-col-admin">Admin</th>
                      <th class="px-4 py-3 text-right"></th>
                    </tr>
                  </thead>
                  <tbody id="rechargeList" class="divide-y divide-gray-800/50"></tbody>
                </table>
              </div>
              
              <!-- Empty State -->
              <div id="rechargeEmptyState" class="hidden text-center py-12 text-gray-500">
                <span class="text-4xl block mb-3">üì≠</span>
                <p>No transactions found for this date</p>
              </div>
              
              <!-- No Results State -->
              <div id="rechargeNoResults" class="hidden text-center py-8 text-gray-500">
                <span class="text-2xl block mb-2">üîç</span>
                <p>No matching transactions found</p>
              </div>
            </div>

            <!-- Collapsible Audit Log -->
            <div class="neon-card rounded-xl relative overflow-hidden">
              <button id="auditToggle" class="w-full p-4 flex items-center justify-between text-left hover:bg-gray-800/30 transition-colors">
                <div class="flex items-center gap-3">
                  <span style="color: var(--neon-purple);">üîê</span>
                  <h3 class="font-orbitron text-sm font-bold" style="color: var(--neon-purple);">AUDIT LOG</h3>
                  <span id="auditCount" class="text-xs px-2 py-0.5 rounded-full" style="background: rgba(184,41,255,0.2); color: var(--neon-purple);">0</span>
                </div>
                <i data-lucide="chevron-down" id="auditChevron" class="w-5 h-5 transition-transform" style="color: var(--neon-purple);"></i>
              </button>
              <div id="auditLogContainer" class="hidden border-t border-gray-800">
                <div class="p-4 flex items-center justify-between border-b border-gray-800/50">
                  <div class="flex gap-2">
                    <button onclick="filterAudit('all')" class="audit-filter active text-xs px-3 py-1 rounded-full" data-filter="all">All</button>
                    <button onclick="filterAudit('ADD')" class="audit-filter text-xs px-3 py-1 rounded-full" data-filter="ADD">Added</button>
                    <button onclick="filterAudit('EDIT')" class="audit-filter text-xs px-3 py-1 rounded-full" data-filter="EDIT">Edited</button>
                    <button onclick="filterAudit('DELETE')" class="audit-filter text-xs px-3 py-1 rounded-full" data-filter="DELETE">Deleted</button>
                  </div>
                  <button onclick="loadMoreAudit()" class="text-xs px-3 py-1 rounded-lg" style="color: var(--neon-cyan);">Load More</button>
                </div>
                <div id="auditLog" class="max-h-96 overflow-y-auto p-4 space-y-2"></div>
              </div>
            </div>
          </div>
        </div>


        <!-- Analytics Section -->
        <div id="analytics-section" class="hidden">
          <h2 class="font-orbitron text-2xl font-bold mb-6 glow-cyan flex items-center gap-3" style="color: var(--neon-cyan);">
            <i data-lucide="bar-chart-3" class="w-7 h-7"></i> ANALYTICS DASHBOARD
          </h2>
          <div id="analytics-content"></div>
        </div>

        <!-- Staff Management Section -->
        <div id="staff-section" class="hidden">
          <h2 class="font-orbitron text-2xl font-bold mb-6 glow-yellow flex items-center gap-3" style="color: var(--neon-yellow);">
            <i data-lucide="shield-check" class="w-7 h-7"></i> STAFF MANAGEMENT
          </h2>
          <div id="staff-content"></div>
        </div>

        <!-- Cash Register Section -->
        <div id="cash-section" class="hidden">
          <h2 class="font-orbitron text-2xl font-bold mb-6 flex items-center gap-3" style="color: var(--neon-green);">
            <i data-lucide="banknote" class="w-7 h-7"></i> CASH REGISTER
          </h2>
          <div id="cash-register-content"></div>
        </div>

        <!-- Leaderboards Section -->
        <div id="leaderboard-section" class="hidden">
          <h2 class="font-orbitron text-2xl font-bold mb-6 flex items-center gap-3" style="color: var(--neon-yellow);">
            <i data-lucide="trophy" class="w-7 h-7"></i> LEADERBOARDS
          </h2>
          
          <div class="space-y-6">
            <!-- Stats Summary -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="neon-card rounded-xl p-4 text-center">
                <div class="text-gray-400 text-xs uppercase tracking-wider">Active Players</div>
                <div id="lb-activePlayers" class="text-2xl font-bold font-orbitron mt-1" style="color: var(--neon-cyan);">-</div>
              </div>
              <div class="neon-card rounded-xl p-4 text-center">
                <div class="text-gray-400 text-xs uppercase tracking-wider">Total Hours</div>
                <div id="lb-totalHours" class="text-2xl font-bold font-orbitron mt-1" style="color: var(--neon-purple);">-</div>
              </div>
              <div class="neon-card rounded-xl p-4 text-center">
                <div class="text-gray-400 text-xs uppercase tracking-wider">Top Player</div>
                <div id="lb-topPlayer" class="text-lg font-bold font-orbitron mt-1 truncate" style="color: var(--neon-yellow);">-</div>
              </div>
              <div class="neon-card rounded-xl p-4 text-center">
                <div class="text-gray-400 text-xs uppercase tracking-wider">Their Hours</div>
                <div id="lb-topPlayerHours" class="text-2xl font-bold font-orbitron mt-1" style="color: var(--neon-green);">-</div>
              </div>
            </div>

            <!-- Tab Buttons -->
            <div class="flex flex-wrap gap-2">
              <button id="lb-tab-alltime" class="lb-tab-btn active px-4 py-2 rounded-lg font-orbitron text-sm" onclick="switchLeaderboardTab('alltime')">
                üèÜ Hall of Fame
              </button>
              <button id="lb-tab-weekly" class="lb-tab-btn px-4 py-2 rounded-lg font-orbitron text-sm" onclick="switchLeaderboardTab('weekly')">
                üìÜ Weekly
              </button>
              <button id="lb-tab-monthly" class="lb-tab-btn px-4 py-2 rounded-lg font-orbitron text-sm" onclick="switchLeaderboardTab('monthly')">
                üìÖ Monthly
              </button>
            </div>

            <!-- All-Time Leaderboard -->
            <div id="lb-alltime-content" class="neon-card rounded-2xl p-6">
              <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                <h3 class="font-orbitron text-lg font-bold flex items-center gap-3" style="color: var(--neon-yellow);">
                  üèÜ HALL OF FAME - ALL TIME
                </h3>
              </div>
              <div class="cyber-line my-4"></div>
              <div id="adminLeaderboardList" class="space-y-3">
                <p class="text-gray-500 text-center">Loading leaderboard...</p>
              </div>
            </div>

            <!-- Weekly Leaderboard -->
            <div id="lb-weekly-content" class="hidden neon-card rounded-2xl p-6">
              <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                <h3 class="font-orbitron text-lg font-bold flex items-center gap-3" style="color: var(--neon-green);">
                  üìÜ THIS WEEK'S TOP PLAYERS
                </h3>
                <select id="weekSelector" onchange="onWeekChange()" class="bg-black/50 border border-gray-700 rounded px-3 py-1 text-sm">
                  <option value="">Loading weeks...</option>
                </select>
              </div>
              <div class="cyber-line my-4"></div>
              <div id="adminWeeklyLeaderboard" class="space-y-3">
                <p class="text-gray-500 text-center">Select a week to view leaderboard...</p>
              </div>
            </div>

            <!-- Monthly Leaderboard -->
            <div id="lb-monthly-content" class="hidden neon-card rounded-2xl p-6">
              <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                <h3 class="font-orbitron text-lg font-bold flex items-center gap-3" style="color: var(--neon-cyan);">
                  üìÖ MONTHLY LEADERBOARD
                </h3>
                <select id="monthSelector" onchange="loadSelectedMonth()" class="neon-input px-3 py-2 rounded-lg text-sm font-orbitron" style="max-width: 180px;">
                  <option value="">Loading...</option>
                </select>
              </div>
              <div class="cyber-line my-4"></div>
              <div id="adminMonthlyLeaderboard" class="space-y-3">
                <p class="text-gray-500 text-center">Select a month to view leaderboard...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Auth Check -->
  <script type="module">
    import { BOOKING_DB_CONFIG, AUTH_APP_NAME } from "../shared/config.js";
    import { getStaffSession, handleStaffLogin } from "./js/permissions.js";
    
    const authApp = firebase.initializeApp(BOOKING_DB_CONFIG, AUTH_APP_NAME);
    const auth = firebase.auth(authApp);
    
    // Expose auth globally for logout functionality
    window.firebaseAuth = auth;
    
    auth.onAuthStateChanged(async (user) => {
      const loadingScreen = document.getElementById("loading-screen");
      const app = document.getElementById("app");
      
      if (user) {
        // Check if staff session exists
        let session = getStaffSession();
        
        // If no session or session email doesn't match, try to create/refresh it
        if (!session || session.email?.toLowerCase() !== user.email?.toLowerCase()) {
          console.log("üîÑ Creating/refreshing staff session for:", user.email);
          try {
            session = await handleStaffLogin(user.email, user.displayName);
          } catch (err) {
            console.error("‚ùå Failed to create staff session:", err);
          }
        }
        
        // Final check - if still no session, redirect to login
        if (!session) {
          console.error("‚ùå No staff session available - redirecting to login");
          window.location.replace("index.html");
          return;
        }
        
        console.log("‚úÖ Staff session verified:", session.name, "Role:", session.role);
        
        // Check if user should be redirected to POS counter
        if (session.role === "COUNTER") {
          console.log("üßæ Counter role detected - redirecting to POS interface");
          window.location.replace("counter.html");
          return;
        }
        
        loadingScreen.classList.add("hidden");
        app.classList.remove("hidden");
        lucide.createIcons();
      } else {
        console.log("üëã No user - redirecting to login");
        window.location.replace("index.html");
      }
    });
    
    document.addEventListener("DOMContentLoaded", () => {
      // Logout is handled by dashboard.js with modal

      // Mobile Sidebar Toggle
      const sidebar = document.getElementById("sidebar");
      const backdrop = document.getElementById("sidebar-backdrop");
      const hamburgerBtn = document.getElementById("hamburger-btn");
      const closeBtn = document.getElementById("sidebar-close");

      function openSidebar() {
        sidebar?.classList.add("open");
        backdrop?.classList.add("show");
        hamburgerBtn?.classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function closeSidebar() {
        sidebar?.classList.remove("open");
        backdrop?.classList.remove("show");
        hamburgerBtn?.classList.remove("active");
        document.body.style.overflow = "";
      }

      hamburgerBtn?.addEventListener("click", () => {
        if (sidebar?.classList.contains("open")) {
          closeSidebar();
        } else {
          openSidebar();
        }
      });

      closeBtn?.addEventListener("click", closeSidebar);
      backdrop?.addEventListener("click", closeSidebar);

      // Close sidebar when nav item is clicked (mobile)
      document.querySelectorAll(".sidebar .nav-item").forEach(item => {
        item.addEventListener("click", () => {
          if (window.innerWidth < 768) {
            closeSidebar();
          }
        });
      });

      // Close sidebar on escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && sidebar?.classList.contains("open")) {
          closeSidebar();
        }
      });

      // Service Worker Registration
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('../sw.js')
          .then(reg => console.log('SW registered:', reg.scope))
          .catch(err => console.log('SW registration failed:', err));
      }

      // PWA Install Prompt
      let deferredPrompt;
      const installBanner = document.getElementById('installBanner');
      const installBtn = document.getElementById('installBtn');
      const dismissBtn = document.getElementById('dismissInstall');

      const installDismissed = localStorage.getItem('adminPwaInstallDismissed');
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        if (!installDismissed && !isStandalone) {
          setTimeout(() => {
            installBanner?.classList.remove('hidden');
          }, 3000);
        }
      });

      installBtn?.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        deferredPrompt = null;
        installBanner?.classList.add('hidden');
      });

      dismissBtn?.addEventListener('click', () => {
        installBanner?.classList.add('hidden');
        localStorage.setItem('adminPwaInstallDismissed', 'true');
      });

      window.addEventListener('appinstalled', () => {
        installBanner?.classList.add('hidden');
        deferredPrompt = null;
      });
    });
  </script>

  <!-- Install App Banner -->
  <div id="installBanner" class="fixed bottom-4 left-4 right-4 mx-auto max-w-sm p-4 rounded-xl hidden z-50"
    style="background: linear-gradient(135deg, rgba(255,0,68,0.15), rgba(184,41,255,0.15)); border: 1px solid rgba(255,0,68,0.5); backdrop-filter: blur(10px); animation: slideUp 0.3s ease-out;">
    <div class="flex items-center gap-3">
      <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: rgba(255,0,68,0.2);">
        <svg viewBox="0 0 100 100" class="w-8 h-8">
          <path d="M50,10 L85,25 L85,55 C85,75 50,90 50,90 C50,90 15,75 15,55 L15,25 Z" 
            fill="none" stroke="#ff0044" stroke-width="4"/>
        </svg>
      </div>
      <div class="flex-1">
        <p class="font-orbitron text-sm font-bold" style="color: #ff0044;">Install Admin App</p>
        <p class="text-xs text-gray-400">Quick dashboard access</p>
      </div>
      <button id="installBtn" class="px-4 py-2 rounded-lg font-orbitron text-xs font-bold"
        style="background: linear-gradient(135deg, #ff0044, #b829ff); color: #fff;">
        Install
      </button>
      <button id="dismissInstall" class="text-gray-500 hover:text-white p-1">‚úï</button>
    </div>
  </div>

  <!-- Add Recharge Modal -->
  <div id="addRechargeModal" class="fixed inset-0 z-50 hidden items-center justify-center" style="background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);">
    <div class="neon-card rounded-2xl w-full max-w-lg p-6 mx-4 relative" style="border-color: rgba(0,255,136,0.5);">
      <button onclick="closeAddRechargeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white text-xl">‚úï</button>
      
      <h3 class="font-orbitron text-lg font-bold mb-4" style="color: #00ff88;">‚ûï ADD RECHARGE</h3>
      
      <!-- Member and Total -->
      <div class="space-y-4">
        <!-- Row 1: Member/Guest Input -->
        <div class="relative">
          <label class="text-xs text-gray-500 mb-1 block">Member / Guest</label>
          <div class="flex gap-2">
            <input id="memberInput" placeholder="Search or type name..." class="neon-input flex-1 px-3 py-2 rounded-lg text-white"/>
            <select id="guestTerminalSelect" class="neon-input px-2 py-2 rounded-lg text-white text-xs" style="width: auto; min-width: 90px;" onchange="selectGuestTerminal(this)">
              <option value="">Guest ‚ñæ</option>
            </select>
          </div>
          <div id="memberSuggestions" class="absolute hidden w-full bg-gray-900 border border-gray-700 rounded-lg mt-1 max-h-40 overflow-y-auto z-50"></div>
        </div>
        
        <!-- Row 2: Paid Amount and Free Offer -->
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-gray-500 mb-1 block">Paid Amount</label>
            <input id="totalAmountInput" type="number" placeholder="‚Çπ Paid" class="neon-input w-full px-3 py-2 rounded-lg text-white text-lg font-orbitron" oninput="updateSplitRemaining()" onfocus="this.select()"/>
          </div>
          <div>
            <label class="text-xs mb-1 flex items-center gap-1" style="color: #ffff00;">üéÅ Free (Offer)</label>
            <input id="freeRechargeInput" type="number" placeholder="‚Çπ0" class="neon-input w-full px-3 py-2 rounded-lg text-white text-center" style="border-color: rgba(255,255,0,0.3);" onfocus="this.select()"/>
          </div>
        </div>

        <!-- Split Payment -->
        <div class="p-3 rounded-lg" style="background: rgba(0,0,0,0.3); border: 1px dashed rgba(255,255,255,0.1);">
          <div class="flex items-center justify-between mb-3">
            <span class="text-xs text-gray-400 uppercase tracking-wider">Split Payment</span>
            <span id="splitRemaining" class="text-xs font-orbitron" style="color: #00ff88;">Enter total first</span>
          </div>
          <div class="grid grid-cols-3 gap-3">
            <div>
              <label class="text-xs mb-1 flex items-center gap-1" style="color: #00f0ff;">üíµ Cash</label>
              <input id="cashInput" type="number" placeholder="‚Çπ0" class="neon-input w-full px-3 py-2 rounded-lg text-white text-center" oninput="updateSplitRemaining()" onfocus="this.select()"/>
            </div>
            <div>
              <label class="text-xs mb-1 flex items-center gap-1" style="color: #b829ff;">üì± UPI</label>
              <input id="upiInput" type="number" placeholder="‚Çπ0" class="neon-input w-full px-3 py-2 rounded-lg text-white text-center" oninput="updateSplitRemaining()" onfocus="this.select()"/>
            </div>
            <div>
              <label class="text-xs mb-1 flex items-center gap-1" style="color: #ff6b00;">üîñ Credit</label>
              <input id="creditInput" type="number" placeholder="‚Çπ0" class="neon-input w-full px-3 py-2 rounded-lg text-white text-center" oninput="updateSplitRemaining()" onfocus="this.select()"/>
            </div>
          </div>
          <div class="flex flex-wrap gap-2 mt-3">
            <button onclick="autoFillCash()" class="text-xs px-3 py-1 rounded" style="background: rgba(0,240,255,0.1); color: #00f0ff;">All Cash</button>
            <button onclick="autoFillUpi()" class="text-xs px-3 py-1 rounded" style="background: rgba(184,41,255,0.1); color: #b829ff;">All UPI</button>
            <button onclick="autoFillCredit()" class="text-xs px-3 py-1 rounded" style="background: rgba(255,107,0,0.1); color: #ff6b00;">All Credit</button>
            <button onclick="clearSplit()" class="text-xs px-3 py-1 rounded ml-auto" style="background: rgba(255,0,68,0.1); color: #ff0044;">Clear</button>
          </div>
        </div>

        <!-- Note -->
        <div>
          <label class="text-xs text-gray-500 mb-1 block">Note (Optional)</label>
          <input id="noteInput" placeholder="Add a note..." class="neon-input w-full px-3 py-2 rounded-lg text-white"/>
        </div>

        <!-- Actions -->
        <div class="flex gap-3 pt-2">
          <button onclick="closeAddRechargeModal()" class="flex-1 py-3 rounded-lg font-orbitron text-sm" style="background: rgba(255,255,255,0.05); color: #888;">Cancel</button>
          <button onclick="addRecharge()" class="flex-1 neon-btn neon-btn-green py-3 rounded-lg font-orbitron text-sm">üíæ Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Credit Collection Modal -->
  <div id="collectCreditModal" class="fixed inset-0 z-50 hidden items-center justify-center" style="background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);">
    <div class="neon-card rounded-2xl w-full max-w-md p-6 mx-4 relative" style="border-color: rgba(255,107,0,0.5);">
      <button onclick="closeCollectModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white">‚úï</button>
      
      <h3 class="font-orbitron text-lg font-bold mb-2" style="color: #ff6b00;">üí∞ COLLECT CREDIT</h3>
      <p id="collectModalInfo" class="text-gray-400 text-sm mb-4"></p>
      
      <div class="space-y-4">
        <!-- Pending Amount Display -->
        <div class="p-3 rounded-lg text-center" style="background: rgba(255,107,0,0.1); border: 1px solid rgba(255,107,0,0.3);">
          <div class="text-xs text-gray-400 uppercase tracking-wider">Pending Credit</div>
          <div id="collectPendingAmount" class="text-2xl font-bold font-orbitron mt-1" style="color: #ff6b00;">‚Çπ0</div>
        </div>

        <!-- Split Collection -->
        <div class="p-3 rounded-lg" style="background: rgba(0,0,0,0.3); border: 1px dashed rgba(255,255,255,0.1);">
          <div class="flex items-center justify-between mb-3">
            <span class="text-xs text-gray-400 uppercase tracking-wider">Payment Split</span>
            <span id="collectRemaining" class="text-xs font-orbitron" style="color: #00ff88;">Remaining: ‚Çπ0</span>
          </div>
          <div class="grid grid-cols-3 gap-3">
            <div>
              <label class="text-xs mb-1 flex items-center gap-1" style="color: #00f0ff;">üíµ Cash</label>
              <input id="collectCashInput" type="number" placeholder="‚Çπ0" class="neon-input w-full px-3 py-2 rounded-lg text-white text-center" oninput="updateCollectRemaining()" onfocus="this.select()"/>
            </div>
            <div>
              <label class="text-xs mb-1 flex items-center gap-1" style="color: #b829ff;">üì± UPI</label>
              <input id="collectUpiInput" type="number" placeholder="‚Çπ0" class="neon-input w-full px-3 py-2 rounded-lg text-white text-center" oninput="updateCollectRemaining()" onfocus="this.select()"/>
            </div>
            <div>
              <label class="text-xs mb-1 flex items-center gap-1" style="color: #ff6b00;">üîñ Still Credit</label>
              <input id="collectCreditInput" type="number" placeholder="‚Çπ0" class="neon-input w-full px-3 py-2 rounded-lg text-white text-center" oninput="updateCollectRemaining()" onfocus="this.select()"/>
            </div>
          </div>
          <div class="flex gap-2 mt-3">
            <button onclick="collectAllCash()" class="text-xs px-3 py-1 rounded flex-1" style="background: rgba(0,240,255,0.1); color: #00f0ff;">All Cash</button>
            <button onclick="collectAllUpi()" class="text-xs px-3 py-1 rounded flex-1" style="background: rgba(184,41,255,0.1); color: #b829ff;">All UPI</button>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-3">
          <button onclick="closeCollectModal()" class="flex-1 px-4 py-3 rounded-lg text-gray-400" style="background: rgba(100,100,100,0.2);">Cancel</button>
          <button onclick="confirmCollectCredit()" class="flex-1 px-4 py-3 rounded-lg font-orbitron font-bold" style="background: linear-gradient(135deg, #00ff88, #00cc66); color: #000;">
            ‚úì Confirm Collection
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Logout Confirmation Modal -->
  <div id="logoutModal" class="fixed inset-0 z-50 hidden items-center justify-center" style="background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);">
    <div class="neon-card rounded-2xl w-full max-w-sm p-6 mx-4 relative transform transition-all" style="border-color: rgba(255,0,68,0.5); animation: modalSlideIn 0.3s ease-out;">
      
      <!-- Icon -->
      <div class="text-center mb-6">
        <div class="w-20 h-20 mx-auto rounded-full flex items-center justify-center" 
          style="background: rgba(255,0,68,0.1); border: 2px solid rgba(255,0,68,0.3);">
          <svg viewBox="0 0 24 24" class="w-10 h-10" style="color: #ff0044;" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16 17 21 12 16 7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
        </div>
      </div>
      
      <!-- Content -->
      <div class="text-center mb-6">
        <h3 class="font-orbitron text-xl font-bold mb-2" style="color: #ff0044;">LOGOUT</h3>
        <p class="text-gray-400">Are you sure you want to end your session?</p>
        <p id="logoutUserInfo" class="text-sm mt-2" style="color: #00f0ff;"></p>
      </div>
      
      <!-- Buttons -->
      <div class="flex gap-3">
        <button id="logoutCancelBtn" class="flex-1 px-4 py-3 rounded-lg font-orbitron text-sm transition-all hover:bg-gray-700" 
          style="background: rgba(100,100,100,0.3); color: #888;">
          Cancel
        </button>
        <button id="logoutConfirmBtn" class="flex-1 px-4 py-3 rounded-lg font-orbitron text-sm font-bold transition-all"
          style="background: linear-gradient(135deg, #ff0044, #cc0033); color: #fff;">
          <span id="logoutBtnText">Logout</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Database Sync Panel Modal -->
  <div id="dbSyncPanel" class="fixed inset-0 z-50 hidden items-center justify-center" style="background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);">
    <div class="neon-card rounded-2xl w-full max-w-lg max-h-[90vh] overflow-hidden mx-4 relative" style="border-color: rgba(0,255,136,0.5); animation: modalSlideIn 0.3s ease-out;">
      <!-- Header -->
      <div class="p-4 border-b border-gray-800 flex items-center justify-between">
        <h3 class="font-orbitron text-lg font-bold flex items-center gap-3" style="color: #00ff88;">
          <i data-lucide="database" class="w-5 h-5"></i>
          DATABASE SYNC
        </h3>
        <button onclick="closeSyncPanel()" class="text-gray-500 hover:text-white text-xl transition-colors">‚úï</button>
      </div>
      
      <!-- Service Status -->
      <div id="syncServerStatus" class="p-4 border-b border-gray-800">
        <div class="flex items-center gap-3">
          <div id="syncServerDot" class="w-3 h-3 rounded-full bg-gray-600 animate-pulse"></div>
          <span id="syncServerText" class="text-sm text-gray-400">Checking sync service...</span>
        </div>
        <!-- Auto-Sync Schedule -->
        <div id="autoSyncSchedule" class="mt-3 p-2 rounded-lg hidden" style="background: rgba(0,255,136,0.05); border: 1px solid rgba(0,255,136,0.2);">
          <div class="text-xs text-gray-500 mb-2">‚è∞ Auto-Sync Schedule</div>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <div>
              <span class="text-gray-500">Terminals:</span>
              <span id="scheduleTerminals" class="text-cyan-400 ml-1">every 2m</span>
            </div>
            <div>
              <span class="text-gray-500">FDB:</span>
              <span id="scheduleFdb" class="text-purple-400 ml-1">every 15m</span>
            </div>
            <div>
              <span class="text-gray-500">Next Term:</span>
              <span id="nextTerminals" class="text-gray-400 ml-1">-</span>
            </div>
            <div>
              <span class="text-gray-500">Next FDB:</span>
              <span id="nextFdb" class="text-gray-400 ml-1">-</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Last Sync Status -->
      <div id="lastSyncStatus" class="p-4 border-b border-gray-800">
        <div class="text-xs text-gray-500 mb-3 uppercase tracking-wider">Last Sync Status</div>
        <div class="grid grid-cols-3 gap-3">
          <!-- FDB Sync -->
          <div class="p-2 rounded-lg" style="background: rgba(184,41,255,0.05); border: 1px solid rgba(184,41,255,0.2);">
            <div class="flex items-center gap-2 mb-1">
              <div id="fdbStatusDot" class="w-2 h-2 rounded-full bg-gray-600"></div>
              <span class="text-xs font-medium" style="color: #b829ff;">FDB</span>
            </div>
            <div id="fdbLastSync" class="text-[10px] text-gray-500">Loading...</div>
          </div>
          <!-- Terminals Sync -->
          <div class="p-2 rounded-lg" style="background: rgba(0,240,255,0.05); border: 1px solid rgba(0,240,255,0.2);">
            <div class="flex items-center gap-2 mb-1">
              <div id="terminalsStatusDot" class="w-2 h-2 rounded-full bg-gray-600"></div>
              <span class="text-xs font-medium" style="color: #00f0ff;">Terminals</span>
            </div>
            <div id="terminalsLastSync" class="text-[10px] text-gray-500">Loading...</div>
          </div>
          <!-- Leaderboard Sync -->
          <div class="p-2 rounded-lg" style="background: rgba(255,215,0,0.05); border: 1px solid rgba(255,215,0,0.2);">
            <div class="flex items-center gap-2 mb-1">
              <div id="leaderboardStatusDot" class="w-2 h-2 rounded-full bg-gray-600"></div>
              <span class="text-xs font-medium" style="color: #ffd700;">Leaders</span>
            </div>
            <div id="leaderboardLastSync" class="text-[10px] text-gray-500">Loading...</div>
          </div>
        </div>
      </div>
      
      <!-- Sync Buttons -->
      <div class="p-4 space-y-3">
        <button onclick="triggerSync('all')" id="syncAllBtn" class="sync-action-btn w-full flex items-center gap-4 p-4 rounded-xl transition-all" disabled
          style="background: linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,240,255,0.1)); border: 1px solid rgba(0,255,136,0.3);">
          <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: rgba(0,255,136,0.2);">
            <i data-lucide="refresh-cw" class="w-5 h-5" style="color: #00ff88;"></i>
          </div>
          <div class="flex-1 text-left">
            <div class="font-semibold text-white">Full Sync</div>
            <div class="text-xs text-gray-500">FDB Data ‚Üí Terminals ‚Üí Leaderboards</div>
          </div>
          <i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i>
        </button>
        
        <div class="text-xs text-gray-500 text-center mt-2">
          Auto-sync runs in background when service is online
        </div>
      </div>
      
      <!-- Progress Area -->
      <div id="syncProgressArea" class="hidden border-t border-gray-800">
        <div class="p-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium" style="color: #00ff88;">
              <span id="syncProgressTitle">Syncing...</span>
            </span>
            <span id="syncProgressStatus" class="text-xs text-gray-500">In progress</span>
          </div>
          <div class="w-full h-1 rounded-full bg-gray-800 overflow-hidden">
            <div id="syncProgressBar" class="h-full rounded-full transition-all duration-300" 
              style="background: linear-gradient(90deg, #00ff88, #00f0ff); width: 0%;"></div>
          </div>
        </div>
        
        <!-- Log Output -->
        <div id="syncLogOutput" class="bg-black/50 p-3 max-h-48 overflow-y-auto font-mono text-xs space-y-1 scrollbar-thin">
          <div class="text-gray-600">Waiting for output...</div>
        </div>
      </div>
      
      <!-- Footer Info -->
      <div class="p-3 border-t border-gray-800 text-center">
        <p class="text-xs text-gray-600">
          Sync server must be running on the counter computer
          <br>
          <code class="text-gray-500">python sync_server.py</code>
        </p>
      </div>
    </div>
  </div>

  <!-- PanCafe Sync Modal -->
  <div id="syncModal" class="fixed inset-0 z-50 hidden items-center justify-center" style="background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);">
    <div class="neon-card rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden mx-4 relative" style="border-color: rgba(0,240,255,0.5); animation: modalSlideIn 0.3s ease-out;">
      <!-- Header -->
      <div class="p-4 border-b border-gray-800 flex items-center justify-between">
        <h3 class="font-orbitron text-lg font-bold flex items-center gap-3" style="color: #00f0ff;">
          üîÑ SYNC WITH PANCAFE
          <span id="syncDateBadge" class="text-xs px-2 py-0.5 rounded" style="background: rgba(0,240,255,0.2);"></span>
        </h3>
        <button onclick="closeSyncModal()" class="text-gray-500 hover:text-white text-xl transition-colors">‚úï</button>
      </div>
      
      <!-- Loading State -->
      <div id="syncLoading" class="hidden p-8 text-center">
        <div class="w-16 h-16 mx-auto mb-4 relative">
          <div class="absolute inset-0 loading-spinner rounded-full animate-spin"></div>
        </div>
        <p class="text-gray-400 font-orbitron text-sm">ANALYZING TRANSACTIONS...</p>
      </div>
      
      <!-- Results -->
      <div id="syncResults" class="hidden overflow-y-auto" style="max-height: calc(90vh - 180px);">
        <!-- Summary Cards -->
        <div class="p-4 grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="stat-card p-3 rounded-xl text-center" style="border-color: rgba(0,255,136,0.3);">
            <div class="text-xs text-gray-500 uppercase">Matched</div>
            <div id="syncMatched" class="text-2xl font-bold font-orbitron" style="color: #00ff88;">0</div>
          </div>
          <div class="stat-card p-3 rounded-xl text-center" style="border-color: rgba(255,255,0,0.3);">
            <div class="text-xs text-gray-500 uppercase">Only in Admin</div>
            <div id="syncOnlyAdmin" class="text-2xl font-bold font-orbitron" style="color: #ffff00;">0</div>
          </div>
          <div class="stat-card p-3 rounded-xl text-center" style="border-color: rgba(255,0,68,0.3);">
            <div class="text-xs text-gray-500 uppercase">Only in PanCafe</div>
            <div id="syncOnlyPanCafe" class="text-2xl font-bold font-orbitron" style="color: #ff0044;">0</div>
          </div>
          <div class="stat-card p-3 rounded-xl text-center" style="border-color: rgba(184,41,255,0.3);">
            <div class="text-xs text-gray-500 uppercase">Amount Mismatch</div>
            <div id="syncMismatch" class="text-2xl font-bold font-orbitron" style="color: #b829ff;">0</div>
          </div>
        </div>
        
        <!-- Tabs -->
        <div class="px-4 flex gap-2 border-b border-gray-800">
          <button onclick="filterSyncResults('all')" class="sync-tab active px-4 py-2 text-sm font-medium transition-colors" data-tab="all">All</button>
          <button onclick="filterSyncResults('matched')" class="sync-tab px-4 py-2 text-sm font-medium transition-colors" data-tab="matched">‚úÖ Matched</button>
          <button onclick="filterSyncResults('admin-only')" class="sync-tab px-4 py-2 text-sm font-medium transition-colors" data-tab="admin-only">‚ö†Ô∏è Admin Only</button>
          <button onclick="filterSyncResults('pancafe-only')" class="sync-tab px-4 py-2 text-sm font-medium transition-colors" data-tab="pancafe-only">‚ùå PanCafe Only</button>
          <button onclick="filterSyncResults('mismatch')" class="sync-tab px-4 py-2 text-sm font-medium transition-colors" data-tab="mismatch">üîÑ Mismatch</button>
        </div>
        
        <!-- Results List -->
        <div id="syncResultsList" class="p-4 space-y-2"></div>
      </div>
      
      <!-- Error State -->
      <div id="syncError" class="hidden p-8 text-center">
        <span class="text-5xl block mb-4">‚ùå</span>
        <p id="syncErrorMsg" class="text-gray-400 mb-4"></p>
        <button onclick="runSync()" class="neon-btn neon-btn-cyan px-6 py-2 rounded-lg">Retry</button>
      </div>
      
      <!-- Footer -->
      <div class="p-4 border-t border-gray-800 flex items-center justify-between">
        <div id="syncSummary" class="text-sm text-gray-500"></div>
        <div class="flex gap-2">
          <button onclick="exportSyncReport()" class="neon-btn neon-btn-purple px-4 py-2 rounded-lg text-sm">üìÑ Export PDF</button>
          <button onclick="closeSyncModal()" class="px-4 py-2 rounded-lg text-gray-400" style="background: rgba(100,100,100,0.2);">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Details Modal -->
  <div id="bookingDetailsModal" class="fixed inset-0 z-50 hidden items-center justify-center" style="background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);">
    <div class="neon-card rounded-2xl w-full max-w-md mx-4" style="animation: modalSlideIn 0.3s ease-out;">
      <!-- Header -->
      <div class="p-4 border-b border-gray-800 flex items-center justify-between">
        <h3 class="font-orbitron text-sm font-bold" style="color: #00f0ff;">üìã BOOKING DETAILS</h3>
        <button onclick="closeBookingModal()" class="text-gray-500 hover:text-white transition-colors">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      
      <!-- Content -->
      <div class="p-4">
        <!-- User Info -->
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg" style="background: linear-gradient(135deg, rgba(0,240,255,0.2), rgba(184,41,255,0.2)); border: 1px solid rgba(0,240,255,0.3);">
            üë§
          </div>
          <div>
            <div id="bookingModalName" class="font-orbitron text-sm font-bold" style="color: #00f0ff;"></div>
            <div id="bookingModalStatus" class="text-xs mt-0.5"></div>
          </div>
        </div>
        
        <!-- Details Grid -->
        <div class="grid grid-cols-2 gap-3 mb-4">
          <div class="p-3 rounded-lg" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05);">
            <div class="text-[10px] text-gray-500 uppercase mb-1">Date</div>
            <div id="bookingModalDate" class="text-sm font-medium text-white"></div>
          </div>
          <div class="p-3 rounded-lg" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05);">
            <div class="text-[10px] text-gray-500 uppercase mb-1">Terminal</div>
            <div id="bookingModalPC" class="text-sm font-medium" style="color: #00ff88;"></div>
          </div>
          <div class="p-3 rounded-lg" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05);">
            <div class="text-[10px] text-gray-500 uppercase mb-1">Time</div>
            <div id="bookingModalTime" class="text-sm font-medium text-white"></div>
          </div>
          <div class="p-3 rounded-lg" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05);">
            <div class="text-[10px] text-gray-500 uppercase mb-1">Duration</div>
            <div id="bookingModalDuration" class="text-sm font-medium" style="color: #b829ff;"></div>
          </div>
        </div>
        
        <!-- Price -->
        <div class="p-3 rounded-lg mb-4 flex items-center justify-between" style="background: linear-gradient(135deg, rgba(255,255,0,0.1), rgba(255,200,0,0.05)); border: 1px solid rgba(255,255,0,0.2);">
          <span class="text-sm text-gray-400">Price</span>
          <span id="bookingModalPrice" class="font-orbitron text-lg font-bold" style="color: #ffff00;"></span>
        </div>
        
        <!-- Action Info -->
        <div id="bookingModalActionInfo" class="text-xs text-gray-500 mb-4 hidden"></div>
        
        <!-- Note -->
        <div id="bookingModalNoteWrapper" class="p-3 rounded-lg mb-4 hidden" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05);">
          <div class="text-[10px] text-gray-500 uppercase mb-1">Note</div>
          <div id="bookingModalNote" class="text-sm text-gray-300"></div>
        </div>
      </div>
      
      <!-- Actions -->
      <div id="bookingModalActions" class="p-4 border-t border-gray-800 flex gap-2">
        <!-- Dynamic buttons will be added here -->
      </div>
    </div>
  </div>

  <style>
    @keyframes slideUp {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes modalSlideIn {
      from { transform: scale(0.9) translateY(-20px); opacity: 0; }
      to { transform: scale(1) translateY(0); opacity: 1; }
    }
    
    #logoutConfirmBtn:hover {
      box-shadow: 0 0 20px rgba(255, 0, 68, 0.5);
      transform: translateY(-1px);
    }
    
    #logoutCancelBtn:hover {
      color: #fff;
    }
    
    /* Sync Modal Tabs */
    .sync-tab {
      color: #666;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    
    .sync-tab:hover {
      color: #00f0ff;
    }
    
    .sync-tab.active {
      color: #00f0ff;
      border-bottom-color: #00f0ff;
    }
    
    /* Sync Result Items */
    .sync-item {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 12px;
      transition: all 0.2s ease;
    }
    
    .sync-item:hover {
      background: rgba(0,0,0,0.5);
    }
    
    .sync-item.matched {
      border-left: 3px solid #00ff88;
    }
    
    .sync-item.admin-only {
      border-left: 3px solid #ffff00;
    }
    
    .sync-item.pancafe-only {
      border-left: 3px solid #ff0044;
    }
    
    .sync-item.mismatch {
      border-left: 3px solid #b829ff;
    }
    
    /* Database Sync Panel Styles */
    .sync-action-btn {
      cursor: pointer;
      opacity: 1;
      transition: all 0.2s ease;
    }
    
    .sync-action-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 255, 136, 0.2);
    }
    
    .sync-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    #syncLogOutput {
      background: rgba(0, 0, 0, 0.6);
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    #syncLogOutput::-webkit-scrollbar {
      width: 4px;
    }
    
    #syncLogOutput::-webkit-scrollbar-thumb {
      background: rgba(0, 255, 136, 0.3);
      border-radius: 2px;
    }
  </style>

  <script src="../shared/pdf-export.js"></script>
  <script type="module" src="../shared/notify.js"></script>
  <script type="module" src="../shared/leaderboard.js"></script>
  <script type="module" src="js/dashboard.js"></script>
  <script type="module" src="js/bookings.js"></script>
  <script type="module" src="js/recharges.js"></script>
  <script type="module" src="js/analytics.js"></script>
  <script type="module" src="js/staff.js"></script>
  <script type="module" src="js/cash-register.js"></script>
  
  <!-- Leaderboard handlers -->
  <script type="module">
    import { loadHallOfFame, loadMonthlyLeaderboard, loadWeeklyLeaderboard, getAvailableMonths, getAvailableWeeks, getLeaderboardStats } from '../shared/leaderboard.js';
    
    let leaderboardLoaded = false;
    let currentLbTab = 'alltime';
    
    // Switch leaderboard tab
    window.switchLeaderboardTab = function(tab) {
      currentLbTab = tab;
      
      // Update tab buttons
      document.querySelectorAll('.lb-tab-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = 'rgba(255,255,255,0.05)';
        btn.style.color = '#888';
        btn.style.border = '1px solid transparent';
      });
      
      const activeBtn = document.getElementById(`lb-tab-${tab}`);
      if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.style.background = 'rgba(255,255,0,0.1)';
        activeBtn.style.color = '#ffff00';
        activeBtn.style.border = '1px solid rgba(255,255,0,0.3)';
      }
      
      // Show/hide content
      document.getElementById('lb-alltime-content').classList.toggle('hidden', tab !== 'alltime');
      document.getElementById('lb-weekly-content').classList.toggle('hidden', tab !== 'weekly');
      document.getElementById('lb-monthly-content').classList.toggle('hidden', tab !== 'monthly');
      
      // Load data for selected tab
      if (tab === 'weekly') {
        const selector = document.getElementById('weekSelector');
        if (selector && selector.value) {
          loadWeeklyLeaderboard('adminWeeklyLeaderboard', null, selector.value);
        }
      } else if (tab === 'monthly') {
        const selector = document.getElementById('monthSelector');
        if (selector && selector.value) {
          loadMonthlyLeaderboard('adminMonthlyLeaderboard', null, selector.value);
        }
      }
    };
    
    // Load selected month
    window.loadSelectedMonth = function() {
      const selector = document.getElementById('monthSelector');
      if (selector && selector.value) {
        loadMonthlyLeaderboard('adminMonthlyLeaderboard', null, selector.value);
      }
    };
    
    // Load selected week
    window.onWeekChange = function() {
      const selector = document.getElementById('weekSelector');
      if (selector && selector.value) {
        loadWeeklyLeaderboard('adminWeeklyLeaderboard', null, selector.value);
      }
    };
    
    // Initialize leaderboards when section is shown
    window.initLeaderboards = async function() {
      if (leaderboardLoaded) return;
      leaderboardLoaded = true;
      
      // Load stats
      const stats = await getLeaderboardStats();
      document.getElementById('lb-activePlayers').textContent = stats.activePlayers;
      document.getElementById('lb-totalHours').textContent = stats.totalHours.toLocaleString();
      document.getElementById('lb-topPlayer').textContent = stats.topPlayer;
      document.getElementById('lb-topPlayerHours').textContent = stats.topPlayerHours.toLocaleString();
      
      // Load hall of fame
      await loadHallOfFame('adminLeaderboardList');
      
      // Load available weeks for selector
      const weeks = await getAvailableWeeks();
      const weekSelector = document.getElementById('weekSelector');
      if (weekSelector && weeks.length > 0) {
        weekSelector.innerHTML = weeks.map((w, i) => {
          const [year, weekNum] = w.split('-W');
          return `<option value="${w}" ${i === 0 ? 'selected' : ''}>Week ${weekNum}, ${year}</option>`;
        }).join('');
        
        // Auto-load current week
        loadWeeklyLeaderboard('adminWeeklyLeaderboard', null, weeks[0]);
      } else if (weekSelector) {
        weekSelector.innerHTML = '<option value="">No data available</option>';
      }
      
      // Load available months for selector
      const months = await getAvailableMonths();
      const selector = document.getElementById('monthSelector');
      if (selector && months.length > 0) {
        selector.innerHTML = months.map((m, i) => {
          const date = new Date(m + '-01');
          const label = date.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
          return `<option value="${m}" ${i === 0 ? 'selected' : ''}>${label}</option>`;
        }).join('');
        
        // Auto-load current month
        loadMonthlyLeaderboard('adminMonthlyLeaderboard', null, months[0]);
      } else {
        selector.innerHTML = '<option value="">No data available</option>';
      }
      
      // Style the initial active tab
      const activeBtn = document.getElementById('lb-tab-alltime');
      if (activeBtn) {
        activeBtn.style.background = 'rgba(255,255,0,0.1)';
        activeBtn.style.color = '#ffff00';
        activeBtn.style.border = '1px solid rgba(255,255,0,0.3)';
      }
    };
  </script>
  
  <!-- Database Sync Panel - Firebase-based -->
  <script>
    // Firebase URLs for sync control
    const FDB_BASE_URL = 'https://fdb-dataset-default-rtdb.asia-southeast1.firebasedatabase.app';
    const SYNC_CONTROL_URL = `${FDB_BASE_URL}/sync-control.json`;
    const SYNC_REQUEST_URL = `${FDB_BASE_URL}/sync-control/request.json`;
    const SYNC_STATUS_URL = `${FDB_BASE_URL}/sync-control/status.json`;
    const SYNC_PROGRESS_URL = `${FDB_BASE_URL}/sync-control/progress.json`;
    const SYNC_HEARTBEAT_URL = `${FDB_BASE_URL}/sync-control/service_heartbeat.json`;
    const SYNC_LAST_URL = `${FDB_BASE_URL}/sync-control/last_sync.json`;
    const FDB_SYNC_META_URL = `${FDB_BASE_URL}/sync-meta.json`;
    
    let syncServiceOnline = false;
    let progressPollInterval = null;
    
    // Fetch last sync times from Firebase
    async function fetchLastSyncTimes() {
      try {
        const response = await fetch(FDB_SYNC_META_URL);
        if (!response.ok) throw new Error('Failed to fetch');
        
        const data = await response.json();
        
        // Update FDB status
        updateSyncStatusUI('fdb', data?.last_fdb_sync, data?.records_synced);
        
        // Update Terminals status  
        updateSyncStatusUI('terminals', data?.terminals?.last_sync, null, data?.terminals?.status);
        
        // Update Leaderboard status
        updateSyncStatusUI('leaderboard', data?.leaderboard?.last_sync, null, data?.leaderboard?.status);
        
      } catch (error) {
        console.log('Could not fetch sync metadata:', error);
        ['fdb', 'terminals', 'leaderboard'].forEach(type => {
          const el = document.getElementById(`${type}LastSync`);
          if (el) el.textContent = 'No data';
        });
      }
    }
    
    // Update sync status UI for a specific type
    function updateSyncStatusUI(type, lastSync, recordCount, status) {
      const dotEl = document.getElementById(`${type}StatusDot`);
      const textEl = document.getElementById(`${type}LastSync`);
      
      if (!textEl) return;
      
      if (lastSync) {
        const timeAgo = getRelativeTime(lastSync);
        const isRecent = isWithinMinutes(lastSync, type === 'terminals' ? 5 : 60);
        
        if (dotEl) {
          dotEl.className = (status === 'ok' || isRecent) 
            ? 'w-2 h-2 rounded-full bg-green-500' 
            : 'w-2 h-2 rounded-full bg-yellow-500';
        }
        
        let text = timeAgo;
        if (recordCount !== null && recordCount !== undefined) {
          text += ` (${recordCount} new)`;
        }
        textEl.textContent = text;
        textEl.title = new Date(lastSync).toLocaleString();
        
      } else {
        if (dotEl) dotEl.className = 'w-2 h-2 rounded-full bg-gray-600';
        textEl.textContent = 'Never synced';
      }
    }
    
    // Get relative time string
    function getRelativeTime(isoString) {
      const date = new Date(isoString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return `${diffDays}d ago`;
      
      return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
    }
    
    // Check if time is within N minutes
    function isWithinMinutes(isoString, minutes) {
      const date = new Date(isoString);
      const now = new Date();
      return (now - date) < minutes * 60 * 1000;
    }
    
    // Check sync service status via Firebase heartbeat
    async function checkSyncService() {
      const dot = document.getElementById('syncServerDot');
      const text = document.getElementById('syncServerText');
      const statusDot = document.getElementById('syncStatusDot');
      const buttons = document.querySelectorAll('.sync-action-btn');
      const scheduleDiv = document.getElementById('autoSyncSchedule');
      
      try {
        // Check service heartbeat
        const heartbeatRes = await fetch(SYNC_HEARTBEAT_URL);
        const heartbeat = await heartbeatRes.json();
        
        // Check current status
        const statusRes = await fetch(SYNC_STATUS_URL);
        const currentStatus = await statusRes.json();
        
        // Fetch schedule info
        const scheduleRes = await fetch(`${FDB_BASE_URL}/sync-control/schedule.json`);
        const schedule = await scheduleRes.json();
        
        // Service is online if heartbeat is within last 2 minutes
        const heartbeatTime = heartbeat?.timestamp ? new Date(heartbeat.timestamp) : null;
        const isOnline = heartbeatTime && isWithinMinutes(heartbeat.timestamp, 2);
        
        syncServiceOnline = isOnline;
        
        if (isOnline) {
          const isSyncing = currentStatus === 'syncing';
          
          if (dot) {
            dot.className = isSyncing 
              ? 'w-3 h-3 rounded-full bg-cyan-500 animate-pulse' 
              : 'w-3 h-3 rounded-full bg-green-500';
          }
          if (text) {
            text.textContent = isSyncing 
              ? '‚ö° Sync in progress...' 
              : '‚úì Sync service online (auto-sync active)';
            text.style.color = isSyncing ? '#00f0ff' : '#00ff88';
          }
          if (statusDot) statusDot.className = 'ml-auto w-2 h-2 rounded-full bg-green-500';
          
          // Show schedule info
          if (scheduleDiv && schedule) {
            scheduleDiv.classList.remove('hidden');
            
            const scheduleTerminals = document.getElementById('scheduleTerminals');
            const scheduleFdb = document.getElementById('scheduleFdb');
            const nextTerminals = document.getElementById('nextTerminals');
            const nextFdb = document.getElementById('nextFdb');
            
            if (scheduleTerminals) scheduleTerminals.textContent = `every ${schedule.terminals_interval_mins || 2}m`;
            if (scheduleFdb) scheduleFdb.textContent = `every ${schedule.fdb_interval_mins || 15}m`;
            
            if (nextTerminals && schedule.next_terminals) {
              nextTerminals.textContent = getTimeUntil(schedule.next_terminals);
            }
            if (nextFdb && schedule.next_fdb) {
              nextFdb.textContent = getTimeUntil(schedule.next_fdb);
            }
          }
          
          buttons.forEach(btn => btn.disabled = isSyncing);
          
          return true;
        } else {
          throw new Error('Service offline');
        }
        
      } catch (error) {
        syncServiceOnline = false;
        
        if (dot) dot.className = 'w-3 h-3 rounded-full bg-yellow-500 animate-pulse';
        if (text) {
          text.textContent = '‚ö†Ô∏è Sync service offline - Start sync_service.py';
          text.style.color = '#ffaa00';
        }
        if (statusDot) statusDot.className = 'ml-auto w-2 h-2 rounded-full bg-yellow-500';
        if (scheduleDiv) scheduleDiv.classList.add('hidden');
        
        // Still enable buttons - service might come online
        buttons.forEach(btn => btn.disabled = false);
        
        return false;
      }
    }
    
    // Get time until a future ISO timestamp
    function getTimeUntil(isoString) {
      const target = new Date(isoString);
      const now = new Date();
      const diffMs = target - now;
      
      if (diffMs <= 0) return 'now';
      
      const diffSecs = Math.floor(diffMs / 1000);
      const diffMins = Math.floor(diffSecs / 60);
      
      if (diffSecs < 60) return `${diffSecs}s`;
      return `${diffMins}m ${diffSecs % 60}s`;
    }
    
    // Open sync panel
    window.openSyncPanel = function() {
      const panel = document.getElementById('dbSyncPanel');
      if (panel) {
        panel.classList.remove('hidden');
        panel.classList.add('flex');
        checkSyncService();
        fetchLastSyncTimes();
        lucide.createIcons();
      }
    };
    
    // Close sync panel
    window.closeSyncPanel = function() {
      const panel = document.getElementById('dbSyncPanel');
      if (panel) {
        panel.classList.add('hidden');
        panel.classList.remove('flex');
      }
      
      if (progressPollInterval) {
        clearInterval(progressPollInterval);
        progressPollInterval = null;
      }
    };
    
    // Trigger sync via Firebase
    window.triggerSync = async function(type) {
      const progressArea = document.getElementById('syncProgressArea');
      const progressBar = document.getElementById('syncProgressBar');
      const progressTitle = document.getElementById('syncProgressTitle');
      const progressStatus = document.getElementById('syncProgressStatus');
      const logOutput = document.getElementById('syncLogOutput');
      
      // Show progress area
      progressArea.classList.remove('hidden');
      progressBar.style.width = '5%';
      progressBar.style.background = 'linear-gradient(90deg, #00ff88, #00f0ff)';
      progressTitle.textContent = `Requesting ${type} sync...`;
      progressStatus.textContent = 'Sending request...';
      logOutput.innerHTML = '<div class="text-cyan-400">üì° Sending sync request to Firebase...</div>';
      
      // Disable buttons
      document.querySelectorAll('.sync-action-btn').forEach(btn => btn.disabled = true);
      
      try {
        // Write sync request to Firebase with timestamp
        const requestId = `${type}_${Date.now()}`;
        const response = await fetch(SYNC_REQUEST_URL, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestId)
        });
        
        if (!response.ok) {
          throw new Error('Failed to send sync request');
        }
        
        logOutput.innerHTML += '<div class="text-green-400">‚úì Request sent! Waiting for service...</div>';
        progressBar.style.width = '10%';
        
        // Start polling for progress
        startProgressPolling();
        
      } catch (error) {
        logOutput.innerHTML += `<div class="text-red-400">‚ùå Error: ${error.message}</div>`;
        progressStatus.textContent = 'Failed';
        document.querySelectorAll('.sync-action-btn').forEach(btn => btn.disabled = false);
      }
    };
    
    // Poll Firebase for sync progress
    function startProgressPolling() {
      const logOutput = document.getElementById('syncLogOutput');
      const progressBar = document.getElementById('syncProgressBar');
      const progressTitle = document.getElementById('syncProgressTitle');
      const progressStatus = document.getElementById('syncProgressStatus');
      
      let lastProgressLength = 0;
      let noChangeCount = 0;
      
      progressPollInterval = setInterval(async () => {
        try {
          // Fetch current status
          const statusRes = await fetch(SYNC_STATUS_URL);
          const status = await statusRes.json();
          
          // Fetch progress messages
          const progressRes = await fetch(SYNC_PROGRESS_URL);
          const progress = await progressRes.json() || [];
          
          // Update status display
          if (status === 'syncing') {
            progressTitle.textContent = 'Sync in progress...';
            progressStatus.textContent = 'Running';
            
            // Animate progress bar
            const currentWidth = parseInt(progressBar.style.width) || 10;
            if (currentWidth < 85) {
              progressBar.style.width = `${Math.min(currentWidth + 2, 85)}%`;
            }
          }
          
          // Update log with new messages
          if (progress.length > lastProgressLength) {
            const newMessages = progress.slice(lastProgressLength);
            newMessages.forEach(msg => {
              let color = 'text-gray-400';
              if (msg.level === 'SUCCESS' || msg.message?.includes('‚úÖ')) color = 'text-green-400';
              else if (msg.level === 'ERROR' || msg.message?.includes('‚ùå')) color = 'text-red-400';
              else if (msg.message?.includes('‚ö†Ô∏è')) color = 'text-yellow-400';
              else if (msg.message?.includes('üìä') || msg.message?.includes('üîÑ')) color = 'text-cyan-400';
              else if (msg.message?.includes('üì§')) color = 'text-purple-400';
              
              const time = msg.time ? `<span class="text-gray-600 text-xs">[${msg.time.split(' ')[1] || msg.time}]</span> ` : '';
              logOutput.innerHTML += `<div class="${color}">${time}${escapeHtml(msg.message)}</div>`;
            });
            lastProgressLength = progress.length;
            logOutput.scrollTop = logOutput.scrollHeight;
            noChangeCount = 0;
          } else {
            noChangeCount++;
          }
          
          // Check if completed
          if (status === 'completed' || status === 'error') {
            clearInterval(progressPollInterval);
            progressPollInterval = null;
            
            progressBar.style.width = '100%';
            
            if (status === 'completed') {
              progressBar.style.background = 'linear-gradient(90deg, #00ff88, #00ff88)';
              progressTitle.textContent = '‚úÖ Sync Complete!';
              progressStatus.textContent = 'Done';
            } else {
              progressBar.style.background = '#ff4444';
              progressTitle.textContent = '‚ö†Ô∏è Sync Error';
              progressStatus.textContent = 'Error';
            }
            
            // Re-enable buttons
            document.querySelectorAll('.sync-action-btn').forEach(btn => btn.disabled = false);
            
            // Refresh last sync times
            setTimeout(fetchLastSyncTimes, 2000);
          }
          
          // Timeout if no updates for 30 seconds - fail the sync
          if (noChangeCount > 6) { // 6 * 5s = 30s
            clearInterval(progressPollInterval);
            progressPollInterval = null;
            
            // Mark as failed
            progressBar.style.width = '100%';
            progressBar.style.background = '#ff4444';
            progressTitle.textContent = '‚ùå Sync Failed';
            progressStatus.textContent = 'Timeout';
            
            logOutput.innerHTML += '<div class="text-red-400 font-bold">‚ùå Sync service did not respond within 30 seconds.</div>';
            logOutput.innerHTML += '<div class="text-gray-500 text-xs mt-2">Make sure sync_service.py is running on the counter machine.</div>';
            
            document.querySelectorAll('.sync-action-btn').forEach(btn => btn.disabled = false);
            return; // Stop polling
          }
          
        } catch (error) {
          console.error('Error polling progress:', error);
        }
      }, 5000); // Poll every 5 seconds
    }
    
    // Escape HTML for log output
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Check service status periodically when panel is open
    setInterval(() => {
      const panel = document.getElementById('dbSyncPanel');
      if (panel && !panel.classList.contains('hidden')) {
        checkSyncService();
      }
    }, 15000); // Every 15 seconds
  </script>
</body>
</html>
